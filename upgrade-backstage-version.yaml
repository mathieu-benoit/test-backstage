name: Upgrade Backstage version
permissions:
  contents: write
  id-token: write
  pull-requests: write
on:
  schedule:
    - cron: "0 10 * * 1-5"
  workflow_dispatch:
jobs:
  upgrade-backstage-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"
      - name: yarn backstage-cli versions:bump
        run: |
          echo "OLD_BACKSTAGE_VERSION=$(cat backstage.json | jq -r .version)" >> ${{ github.env }}
          export YARN_ENABLE_IMMUTABLE_INSTALLS=false
          yarn install
          yarn backstage-cli versions:bump
          echo "NEW_BACKSTAGE_VERSION=$(cat backstage.json | jq -r .version)" >> ${{ github.env }}
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Upgrade Backstage version from ${{ env.OLD_BACKSTAGE_VERSION }} to ${{ env.NEW_BACKSTAGE_VERSION }}
          title: Upgrade Backstage version from ${{ env.OLD_BACKSTAGE_VERSION }} to ${{ env.NEW_BACKSTAGE_VERSION }}
          body: |
            Upgrade Backstage version from ${{ env.OLD_BACKSTAGE_VERSION }} to ${{ env.NEW_BACKSTAGE_VERSION }}:
            https://github.com/backstage/backstage/releases/tag/v${{ env.NEW_BACKSTAGE_VERSION }}

            - [ ] Set PR as "Ready for review"
            - [ ] Check CI
            - [ ] Check the Backstage upgrade helper: https://backstage.github.io/upgrade-helper/?from=${{ env.OLD_BACKSTAGE_VERSION }}&to=${{ env.NEW_BACKSTAGE_VERSION }}
            - [ ] Submit PR review
          branch: upgrade-backstage
          delete-branch: true
          draft: always-true # Because of: https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#triggering-further-workflow-runs.
